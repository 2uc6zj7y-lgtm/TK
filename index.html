<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ç²’å­æ‰‹åŠ¿è¡¨ç™½ç³»ç»Ÿ</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #050505;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: white;
        }

        canvas {
            display: block;
        }

        /* éšè—è§†é¢‘æºï¼Œåªåšåˆ†æç”¨ */
        #input_video {
            display: none;
        }
        
        /* è°ƒè¯•æ¨¡å¼ï¼šæ˜¾ç¤ºæ‘„åƒå¤´ç”»é¢ */
        #input_video.debug {
            display: block;
            position: fixed;
            top: 20px;
            right: 20px;
            width: 200px;
            height: 150px;
            border: 2px solid #00ffff;
            border-radius: 10px;
            z-index: 1000;
            opacity: 0.8;
        }
        
        .debug-toggle {
            position: fixed;
            top: 20px;
            right: 240px;
            background: rgba(20, 20, 30, 0.9);
            border: 1px solid #333;
            border-radius: 5px;
            padding: 5px 10px;
            color: #aaa;
            font-size: 12px;
            cursor: pointer;
            z-index: 1001;
        }
        
        .debug-toggle:hover {
            border-color: #00ffff;
            color: #00ffff;
        }

        /* å·¦ä¸Šè§’çŠ¶æ€é¢æ¿ */
        .status-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(10, 20, 30, 0.8);
            border: 1px solid #333;
            border-radius: 10px;
            padding: 15px;
            width: 200px;
            backdrop-filter: blur(5px);
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.1);
        }

        .status-title {
            color: #00ffff;
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 16px;
            transition: color 0.3s;
        }

        .status-item {
            font-size: 12px;
            color: #aaa;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
        }

        .status-item span {
            margin-right: 8px;
        }

        .active-gesture {
            color: #00ffff;
            text-shadow: 0 0 5px cyan;
        }

        /* å·¦ä¸‹è§’è¾“å…¥é¢æ¿ */
        .control-panel {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(20, 20, 30, 0.9);
            border: 1px solid #333;
            border-radius: 10px;
            padding: 20px;
            width: 250px;
            backdrop-filter: blur(5px);
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-label {
            font-size: 12px;
            color: #aaa;
            margin-bottom: 5px;
            display: block;
        }

        input[type="text"] {
            width: 100%;
            background: #000;
            border: 1px solid #444;
            color: white;
            padding: 8px;
            border-radius: 5px;
            box-sizing: border-box;
            outline: none;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus {
            border-color: #00ffff;
        }

        .tips {
            font-size: 10px;
            color: #555;
            margin-top: 5px;
        }
    </style>
    <!-- å¼•å…¥ MediaPipe -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.3.1640029074/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils@0.6.1629159509/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils@0.3.1620248257/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4.1646424915/hands.js" crossorigin="anonymous"></script>
    <!-- å¤‡ç”¨CDN -->
    <script>
        // å¦‚æœä¸»CDNåŠ è½½å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨æ–¹æ¡ˆ
        window.addEventListener('error', function(e) {
            if (e.target && e.target.tagName === 'SCRIPT' && e.target.src.includes('mediapipe')) {
                console.warn('MediaPipe CDNåŠ è½½å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨æ–¹æ¡ˆ');
            }
        }, true);
    </script>
</head>
<body>

    <!-- è§†é¢‘è¾“å…¥ (éšè—) -->
    <video id="input_video" autoplay playsinline muted></video>
    
    <!-- ç²’å­ç”»å¸ƒ -->
    <canvas id="canvas"></canvas>

    <!-- çŠ¶æ€é¢æ¿ -->
    <div class="status-panel">
        <div class="status-title" id="gesture-status">ç­‰å¾…æ‰‹åŠ¿...</div>
        <div class="status-item" id="g-one">ğŸ‘† å•æŒ‡: ç¬¬ä¸€ä¸ªå­—</div>
        <div class="status-item" id="g-two">âœŒï¸ åŒæŒ‡: ç¬¬äºŒä¸ªå­—</div>
        <div class="status-item" id="g-open">ğŸ– å¼ æ‰‹: å˜çˆ±å¿ƒ</div>
        <div class="status-item" id="g-fist">âœŠ æ¡æ‹³: çˆ†ç‚¸è¡¨ç™½</div>
    </div>

    <!-- æ§åˆ¶é¢æ¿ -->
    <div class="control-panel">
        <div class="input-group">
            <label class="input-label">åå­— (ä¸¤ä¸ªå­—æ•ˆæœæœ€ä½³)</label>
            <input type="text" id="nameInput" value="ç‹æ ‡" maxlength="4">
        </div>
        <div class="input-group">
            <label class="input-label">è¡¨ç™½å†…å®¹</label>
            <input type="text" id="msgInput" value="æˆ‘æ°¸è¿œçˆ±ä½ ">
        </div>
        <div class="tips">* é¼ æ ‡æ‚¬åœè¾“å…¥æ¡†å¯ä¿®æ”¹å†…å®¹</div>
    </div>
    
    <!-- è°ƒè¯•æŒ‰é’® -->
    <div class="debug-toggle" id="debugToggle" onclick="toggleDebug()">ğŸ” æ˜¾ç¤ºæ‘„åƒå¤´</div>

    <script>
        /**
         * 1. åˆå§‹åŒ–è®¾ç½®
         */
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const videoElement = document.getElementById('input_video');
        
        let width, height;
        let particles = [];
        const particleCount = 3000; // ç²’å­æ€»æ•°ï¼ˆå¢åŠ ä»¥æé«˜æ¸…æ™°åº¦ï¼‰
        const friction = 0.1; // ç¼“åŠ¨ç³»æ•°
        let currentGesture = 'NONE';
        
        // ç”¨æˆ·è‡ªå®šä¹‰å†…å®¹
        let config = {
            name: "ç‹æ ‡",
            message: "æˆ‘æ°¸è¿œçˆ±ä½ "
        };

        // ç»‘å®šè¾“å…¥æ¡†äº‹ä»¶
        document.getElementById('nameInput').addEventListener('input', (e) => {
            config.name = e.target.value || " ";
            if(currentGesture === 'ONE' || currentGesture === 'TWO') updateTargetShape(currentGesture);
        });
        document.getElementById('msgInput').addEventListener('input', (e) => {
            config.message = e.target.value || " ";
            if(currentGesture === 'FIST') updateTargetShape('FIST');
        });

        // è°ƒæ•´ç”»å¸ƒå¤§å°
        function resize() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', () => {
            resize();
            // çª—å£å¤§å°æ”¹å˜æ—¶é‡æ–°åˆå§‹åŒ–ç²’å­ä½ç½®
            particles.forEach(p => {
                if (p.x > width) p.x = width;
                if (p.y > height) p.y = height;
                if (p.tx > width) p.tx = width;
                if (p.ty > height) p.ty = height;
            });
        });
        resize(); // å…ˆåˆå§‹åŒ–å°ºå¯¸

        /**
         * 2. ç²’å­ç³»ç»Ÿ
         */
        class Particle {
            constructor() {
                this.x = Math.random() * width;
                this.y = Math.random() * height;
                this.tx = this.x; // ç›®æ ‡X
                this.ty = this.y; // ç›®æ ‡Y
                this.color = 'rgba(0, 255, 255, 0.8)';
                this.size = 2.5; // ç¨å¾®å¢å¤§ç²’å­å°ºå¯¸ä»¥æé«˜å¯è§åº¦
                this.vx = 0;
                this.vy = 0;
            }

            update() {
                // ç®€å•çš„ç‰©ç†ç¼“åŠ¨
                const dx = this.tx - this.x;
                const dy = this.ty - this.y;
                
                this.vx += dx * 0.05;
                this.vy += dy * 0.05;
                this.vx *= 0.8; // æ‘©æ“¦åŠ›
                this.vy *= 0.8;

                this.x += this.vx;
                this.y += this.vy;
            }

            draw() {
                // ä½¿ç”¨åœ†å½¢ç²’å­ï¼Œçœ‹èµ·æ¥æ›´æŸ”å’Œ
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size / 2, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        // åˆå§‹åŒ–ç²’å­æ± ï¼ˆåœ¨resizeä¹‹åï¼‰
        function initParticles() {
            particles = [];
            for (let i = 0; i < particleCount; i++) {
                particles.push(new Particle());
            }
            // åˆå§‹åŒ–ä¸ºIDLEçŠ¶æ€
            updateTargetShape('IDLE');
        }
        initParticles();

        /**
         * 3. å½¢çŠ¶ç”Ÿæˆé€»è¾‘ (æ–‡å­—/å¿ƒå½¢)
         */
        
        // è¾…åŠ©ï¼šè·å–æ–‡å­—çš„åƒç´ ç‚¹åæ ‡
        function getTextPoints(text, targetFontSize) {
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = width;
            tempCanvas.height = height;
            const tCtx = tempCanvas.getContext('2d');
            
            // åŠ¨æ€è°ƒæ•´å­—ä½“å¤§å°ï¼Œç¡®ä¿æ–‡å­—å®Œæ•´æ˜¾ç¤º
            let fontSize = targetFontSize;
            let textWidth, textHeight;
            let maxAttempts = 10;
            
            do {
                tCtx.font = `bold ${fontSize}px "Microsoft YaHei", "SimHei", "Arial", sans-serif`;
                const metrics = tCtx.measureText(text);
                textWidth = metrics.width;
                textHeight = fontSize * 1.2; // ä¼°ç®—é«˜åº¦
                
                // å¦‚æœæ–‡å­—å¤ªå¤§ï¼Œç¼©å°å­—ä½“
                if (textWidth > width * 0.9 || textHeight > height * 0.9) {
                    fontSize *= 0.9;
                    maxAttempts--;
                } else {
                    break;
                }
            } while (maxAttempts > 0 && fontSize > 20);
            
            // æ¸…é™¤ç”»å¸ƒ
            tCtx.clearRect(0, 0, width, height);
            
            // è®¾ç½®æ–‡å­—æ ·å¼
            tCtx.font = `bold ${fontSize}px "Microsoft YaHei", "SimHei", "Arial", sans-serif`;
            tCtx.fillStyle = '#ffffff';
            tCtx.textAlign = 'center';
            tCtx.textBaseline = 'middle';
            
            // ç»˜åˆ¶æ–‡å­—
            tCtx.fillText(text, width / 2, height / 2);

            // è·å–åƒç´ æ•°æ®
            const imageData = tCtx.getImageData(0, 0, width, height).data;
            const points = [];
            
            // æ ¹æ®å­—ä½“å¤§å°åŠ¨æ€è°ƒæ•´é‡‡æ ·æ­¥é•¿ï¼Œå­—ä½“è¶Šå¤§æ­¥é•¿è¶Šå°
            const step = fontSize > 200 ? 2 : (fontSize > 100 ? 3 : 4);

            for (let y = 0; y < height; y += step) {
                for (let x = 0; x < width; x += step) {
                    const index = (y * width + x) * 4;
                    // æ£€æŸ¥alphaé€šé“ï¼Œç¡®ä¿æ˜¯æ–‡å­—åƒç´ 
                    if (imageData[index + 3] > 128) {
                        points.push({ x: x, y: y });
                    }
                }
            }
            
            console.log(`æ–‡å­— "${text}" æ¸²æŸ“å®Œæˆ: å­—ä½“å¤§å°=${fontSize.toFixed(0)}px, é‡‡æ ·ç‚¹æ•°=${points.length}`);
            return points;
        }

        // è¾…åŠ©ï¼šè·å–å¿ƒå½¢åæ ‡
        function getHeartPoints(count, scale) {
            const points = [];
            for (let i = 0; i < count; i++) {
                // å¿ƒå½¢å‚æ•°æ–¹ç¨‹
                const t = Math.random() * Math.PI * 2;
                // 16sin^3(t)
                const x = 16 * Math.pow(Math.sin(t), 3);
                // 13cos(t) - 5cos(2t) - 2cos(3t) - cos(4t)
                const y = -(13 * Math.cos(t) - 5 * Math.cos(2 * t) - 2 * Math.cos(3 * t) - Math.cos(4 * t));
                
                points.push({
                    x: width / 2 + x * scale,
                    y: height / 2 + y * scale
                });
            }
            return points;
        }

        // æ›´æ–°ç²’å­ç›®æ ‡çŠ¶æ€
        function updateTargetShape(type) {
            let points = [];
            let color = 'rgba(0, 255, 255, 0.8)'; // é»˜è®¤é’è‰²

            if (type === 'IDLE') {
                // æ•£ä¹±æ˜Ÿç©º
                particles.forEach(p => {
                    p.tx = Math.random() * width;
                    p.ty = Math.random() * height;
                    p.color = 'rgba(0, 255, 255, 0.3)';
                });
                return;
            }

            if (type === 'ONE') {
                // åå­—ç¬¬ä¸€ä¸ªå­— - ä½¿ç”¨è¾ƒå¤§çš„å­—ä½“ï¼Œä½†ä¼šè‡ªåŠ¨è°ƒæ•´ç¡®ä¿å®Œæ•´æ˜¾ç¤º
                const char = config.name.charAt(0) || "?";
                const maxFontSize = Math.min(width, height) * 0.6; // æœ€å¤§ä¸è¶…è¿‡å±å¹•çš„60%
                points = getTextPoints(char, maxFontSize);
            } else if (type === 'TWO') {
                // åå­—ç¬¬äºŒä¸ªå­— (å¦‚æœåªæœ‰ä¸€ä¸ªå­—ï¼Œå°±æ˜¾ç¤ºé‚£ä¸ªå­—)
                const char = config.name.length > 1 ? config.name.charAt(1) : config.name.charAt(0);
                const maxFontSize = Math.min(width, height) * 0.6;
                points = getTextPoints(char, maxFontSize);
            } else if (type === 'HEART') {
                // çˆ±å¿ƒ
                points = getHeartPoints(particleCount, 15);
                color = 'rgba(255, 50, 100, 0.9)'; // çº¢è‰²
            } else if (type === 'FIST') {
                // çˆ†ç‚¸è¡¨ç™½ï¼šæ ¹æ®æ–‡å­—é•¿åº¦åŠ¨æ€è°ƒæ•´å­—ä½“å¤§å°
                const messageLength = config.message.length;
                // é•¿æ–‡å­—ç”¨è¾ƒå°å­—ä½“ï¼ŒçŸ­æ–‡å­—ç”¨è¾ƒå¤§å­—ä½“
                let fontSize = Math.min(width, height) * 0.15; // åŸºç¡€å¤§å°
                if (messageLength > 6) {
                    fontSize = Math.min(width, height) * 0.12; // é•¿æ–‡å­—æ›´å°
                } else if (messageLength <= 3) {
                    fontSize = Math.min(width, height) * 0.2; // çŸ­æ–‡å­—æ›´å¤§
                }
                points = getTextPoints(config.message, fontSize);
                color = 'rgba(255, 200, 50, 0.9)'; // é‡‘è‰²
            }

            // åˆ†é…ç›®æ ‡ç‚¹ç»™ç²’å­
            if (points.length > 0) {
                // å¦‚æœç‚¹æ•°å°‘äºç²’å­æ•°ï¼Œéœ€è¦é‡å¤ä½¿ç”¨ç‚¹
                // å¦‚æœç‚¹æ•°å¤šäºç²’å­æ•°ï¼Œéšæœºé€‰æ‹©ç‚¹
                const pointCount = points.length;
                
                particles.forEach((p, i) => {
                    let target;
                    if (pointCount >= particleCount) {
                        // ç‚¹æ•°è¶³å¤Ÿï¼Œå‡åŒ€åˆ†é…
                        const index = Math.floor((i / particleCount) * pointCount);
                        target = points[Math.min(index, pointCount - 1)];
                    } else {
                        // ç‚¹æ•°ä¸å¤Ÿï¼Œå¾ªç¯ä½¿ç”¨å¹¶æ·»åŠ éšæœºåç§»
                        target = points[i % pointCount];
                        // æ·»åŠ å°çš„éšæœºåç§»ï¼Œè®©ç²’å­åˆ†å¸ƒæ›´è‡ªç„¶
                        const offset = 2;
                        target = {
                            x: target.x + (Math.random() - 0.5) * offset,
                            y: target.y + (Math.random() - 0.5) * offset
                        };
                    }
                    
                    p.tx = target.x;
                    p.ty = target.y;
                    p.color = color;
                    
                    // å¦‚æœæ˜¯çˆ†ç‚¸æ¨¡å¼ï¼Œç»™ä¸ªéšæœºæ‰°åŠ¨å¢åŠ åŠ¨æ„Ÿ
                    if (type === 'FIST') {
                        p.tx += (Math.random() - 0.5) * 3;
                        p.ty += (Math.random() - 0.5) * 3;
                    }
                });
                
                console.log(`ç²’å­åˆ†é…å®Œæˆ: ${points.length}ä¸ªç›®æ ‡ç‚¹, ${particleCount}ä¸ªç²’å­`);
            } else {
                console.warn('æ²¡æœ‰ç”Ÿæˆä»»ä½•ç›®æ ‡ç‚¹ï¼');
            }
        }

        /**
         * 4. MediaPipe æ‰‹åŠ¿è¯†åˆ«é€»è¾‘
         */
        
        function detectGesture(landmarks) {
            // æ”¹è¿›çš„æ‰‹æŒ‡åˆ¤æ–­é€»è¾‘
            // ä½¿ç”¨æŒ‡å°–åˆ°æ‰‹è…•çš„è·ç¦»æ¥åˆ¤æ–­æ‰‹æŒ‡æ˜¯å¦ä¼¸å‡º
            
            const wrist = landmarks[0];
            
            // è®¡ç®—æ¯ä¸ªæ‰‹æŒ‡çš„æŒ‡å°–åˆ°æ‰‹è…•çš„è·ç¦»
            const getDistance = (p1, p2) => {
                return Math.sqrt(Math.pow(p1.x - p2.x, 2) + Math.pow(p1.y - p2.y, 2));
            };
            
            // æ‹‡æŒ‡ï¼šæ¯”è¾ƒæŒ‡å°–(4)å’ŒæŒ‡å…³èŠ‚(3)åˆ°æ‰‹è…•çš„è·ç¦»
            const thumbTipDist = getDistance(landmarks[4], wrist);
            const thumbPipDist = getDistance(landmarks[3], wrist);
            const thumbIsOpen = thumbTipDist > thumbPipDist * 1.1;
            
            // å…¶ä»–æ‰‹æŒ‡ï¼šæ¯”è¾ƒæŒ‡å°–(TIP)å’ŒæŒ‡å…³èŠ‚(PIP)çš„yåæ ‡
            // å¯¹äºæ­£å¸¸æ‰‹åŠ¿ï¼ŒæŒ‡å°–åº”è¯¥åœ¨æŒ‡å…³èŠ‚ä¸Šæ–¹ï¼ˆyå€¼æ›´å°ï¼‰
            const indexIsOpen = landmarks[8].y < landmarks[6].y - 0.02;
            const middleIsOpen = landmarks[12].y < landmarks[10].y - 0.02;
            const ringIsOpen = landmarks[16].y < landmarks[14].y - 0.02;
            const pinkyIsOpen = landmarks[20].y < landmarks[18].y - 0.02;

            let fingersCount = 0;
            if (indexIsOpen) fingersCount++;
            if (middleIsOpen) fingersCount++;
            if (ringIsOpen) fingersCount++;
            if (pinkyIsOpen) fingersCount++;

            // è°ƒè¯•ä¿¡æ¯ï¼ˆå¯åœ¨æ§åˆ¶å°æŸ¥çœ‹ï¼‰
            if (window.debugMode) {
                console.log('æ‰‹æŒ‡çŠ¶æ€:', {
                    thumb: thumbIsOpen,
                    index: indexIsOpen,
                    middle: middleIsOpen,
                    ring: ringIsOpen,
                    pinky: pinkyIsOpen,
                    count: fingersCount
                });
            }

            // é€»è¾‘åˆ¤å®šï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰
            // 1. æ¡æ‹³ï¼šæ‰€æœ‰æ‰‹æŒ‡éƒ½æ”¶èµ·
            if (!indexIsOpen && !middleIsOpen && !ringIsOpen && !pinkyIsOpen && !thumbIsOpen) {
                return 'FIST';
            }
            
            // 2. å•æŒ‡ï¼šåªæœ‰é£ŸæŒ‡ä¼¸å‡º
            if (indexIsOpen && !middleIsOpen && !ringIsOpen && !pinkyIsOpen) {
                return 'ONE';
            }
            
            // 3. åŒæŒ‡ï¼šé£ŸæŒ‡å’Œä¸­æŒ‡ä¼¸å‡º
            if (indexIsOpen && middleIsOpen && !ringIsOpen && !pinkyIsOpen) {
                return 'TWO';
            }
            
            // 4. å¼ æ‰‹ï¼š3ä¸ªæˆ–æ›´å¤šæ‰‹æŒ‡ä¼¸å‡ºï¼ˆåŒ…æ‹¬æ‹‡æŒ‡ï¼‰
            if (fingersCount >= 3 || (fingersCount >= 2 && thumbIsOpen)) {
                return 'OPEN';
            }
            
            return 'IDLE';
        }

        function onResults(results) {
            let newGesture = 'IDLE';

            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                // åªå–ç¬¬ä¸€åªæ‰‹
                const landmarks = results.multiHandLandmarks[0];
                newGesture = detectGesture(landmarks);
                
                // æ›´æ–°çŠ¶æ€æ˜¾ç¤ºï¼ˆå³ä½¿æ‰‹åŠ¿æ²¡å˜ï¼Œä¹Ÿæ˜¾ç¤ºæ£€æµ‹åˆ°çš„æ‰‹ï¼‰
                const statusText = document.getElementById('gesture-status');
                if (newGesture === 'IDLE') {
                    statusText.innerText = "æ£€æµ‹åˆ°æ‰‹åŠ¿ï¼Œä½†æœªè¯†åˆ«";
                }
            } else {
                // æ²¡æœ‰æ£€æµ‹åˆ°æ‰‹
                const statusText = document.getElementById('gesture-status');
                statusText.innerText = "ç­‰å¾…æ‰‹åŠ¿... (è¯·å°†æ‰‹æ”¾åœ¨æ‘„åƒå¤´å‰)";
            }

            // çŠ¶æ€åˆ‡æ¢
            if (newGesture !== currentGesture) {
                currentGesture = newGesture;
                
                // æ›´æ–°UIé«˜äº®
                document.querySelectorAll('.status-item').forEach(el => el.classList.remove('active-gesture'));
                const statusText = document.getElementById('gesture-status');
                
                if (currentGesture === 'ONE') {
                    document.getElementById('g-one').classList.add('active-gesture');
                    statusText.innerText = "è¯†åˆ«: å•æŒ‡";
                    updateTargetShape('ONE');
                } else if (currentGesture === 'TWO') {
                    document.getElementById('g-two').classList.add('active-gesture');
                    statusText.innerText = "è¯†åˆ«: åŒæŒ‡";
                    updateTargetShape('TWO');
                } else if (currentGesture === 'OPEN') {
                    document.getElementById('g-open').classList.add('active-gesture');
                    statusText.innerText = "è¯†åˆ«: å¼ æ‰‹ (çˆ±å¿ƒ)";
                    updateTargetShape('HEART');
                } else if (currentGesture === 'FIST') {
                    document.getElementById('g-fist').classList.add('active-gesture');
                    statusText.innerText = "è¯†åˆ«: æ¡æ‹³ (è¡¨ç™½)";
                    updateTargetShape('FIST');
                } else {
                    if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                        statusText.innerText = "æ£€æµ‹åˆ°æ‰‹åŠ¿ï¼Œä½†æœªè¯†åˆ«";
                    } else {
                        statusText.innerText = "ç­‰å¾…æ‰‹åŠ¿...";
                    }
                    updateTargetShape('IDLE');
                }
            }
        }

        /**
         * 5. å¯åŠ¨ä¸æ¸²æŸ“å¾ªç¯
         */
        
        // æ¸²æŸ“å¾ªç¯
        function animate() {
            // ç¡®ä¿widthå’Œheightå·²åˆå§‹åŒ–
            if (width && height) {
                // æ‹–å°¾æ•ˆæœï¼šä¸å®Œå…¨æ¸…é™¤ç”»å¸ƒï¼Œè¦†ç›–ä¸€å±‚åŠé€æ˜é»‘è‰²
                ctx.fillStyle = 'rgba(5, 5, 5, 0.2)';
                ctx.fillRect(0, 0, width, height);

                particles.forEach(p => {
                    p.update();
                    p.draw();
                });
            }

            requestAnimationFrame(animate);
        }
        animate();

        // å¤‡ç”¨æ–¹æ³•ï¼šç›´æ¥ä½¿ç”¨getUserMediaåˆå§‹åŒ–æ‘„åƒå¤´
        let handsInstance = null;
        async function initCameraDirectly() {
            try {
                console.log('å°è¯•ç›´æ¥åˆå§‹åŒ–æ‘„åƒå¤´...');
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        facingMode: 'user'
                    }
                });
                
                videoElement.srcObject = stream;
                
                // ç­‰å¾…è§†é¢‘å…ƒæ•°æ®åŠ è½½
                await new Promise((resolve) => {
                    if (videoElement.readyState >= 2) {
                        resolve();
                    } else {
                        videoElement.addEventListener('loadedmetadata', resolve, { once: true });
                    }
                });
                
                // å¼€å§‹æ’­æ”¾
                await videoElement.play();
                
                console.log('ç›´æ¥åˆå§‹åŒ–æ‘„åƒå¤´æˆåŠŸï¼Œè§†é¢‘å°ºå¯¸:', videoElement.videoWidth, 'x', videoElement.videoHeight);
                
                // å¦‚æœMediaPipeå·²ç»åˆå§‹åŒ–ï¼Œå¼€å§‹å¤„ç†è§†é¢‘å¸§
                if (handsInstance) {
                    console.log('å¼€å§‹ä½¿ç”¨å¤‡ç”¨æ–¹æ³•å¤„ç†è§†é¢‘å¸§...');
                    function processFrame() {
                        if (videoElement.readyState >= 2) {
                            handsInstance.send({image: videoElement});
                        }
                        requestAnimationFrame(processFrame);
                    }
                    processFrame();
                }
                
                return true;
            } catch (err) {
                console.error('ç›´æ¥åˆå§‹åŒ–æ‘„åƒå¤´å¤±è´¥:', err);
                return false;
            }
        }
        
        // åˆå§‹åŒ– MediaPipe Handsï¼ˆç­‰å¾…é¡µé¢åŠ è½½å®Œæˆï¼‰
        function initMediaPipe() {
            console.log('å¼€å§‹åˆå§‹åŒ– MediaPipe...');
            console.log('Hands:', typeof Hands);
            console.log('Camera:', typeof Camera);
            console.log('navigator.mediaDevices:', typeof navigator.mediaDevices);
            
            if (typeof Hands === 'undefined' || typeof Camera === 'undefined') {
                console.error('MediaPipe åº“æœªåŠ è½½ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                const statusText = document.getElementById('gesture-status');
                statusText.innerText = "MediaPipe åº“åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢";
                statusText.style.color = '#ff4444';
                alert('MediaPipe åº“åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–åˆ·æ–°é¡µé¢é‡è¯•ã€‚');
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦æ”¯æŒgetUserMedia
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                console.error('æµè§ˆå™¨ä¸æ”¯æŒæ‘„åƒå¤´API');
                const statusText = document.getElementById('gesture-status');
                statusText.innerText = "æµè§ˆå™¨ä¸æ”¯æŒæ‘„åƒå¤´ï¼Œè¯·ä½¿ç”¨Chromeæˆ–Edge";
                statusText.style.color = '#ff4444';
                alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒæ‘„åƒå¤´åŠŸèƒ½ï¼Œè¯·ä½¿ç”¨Chromeæˆ–Edgeæµè§ˆå™¨ã€‚');
                return;
            }

            console.log('åˆ›å»º Hands å®ä¾‹...');
            const hands = new Hands({locateFile: (file) => {
                return `https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4.1646424915/${file}`;
            }});
            
            hands.setOptions({
                maxNumHands: 1,
                modelComplexity: 1,
                minDetectionConfidence: 0.5, // é™ä½æ£€æµ‹é˜ˆå€¼ï¼Œæ›´å®¹æ˜“æ£€æµ‹
                minTrackingConfidence: 0.5
            });
            
            hands.onResults(onResults);
            handsInstance = hands; // ä¿å­˜å®ä¾‹ä¾›å¤‡ç”¨æ–¹æ³•ä½¿ç”¨
            console.log('Hands é…ç½®å®Œæˆ');

            console.log('åˆ›å»º Camera å®ä¾‹...');
            
            // ç¡®ä¿è§†é¢‘å…ƒç´ æœ‰å¿…è¦çš„å±æ€§
            videoElement.setAttribute('autoplay', '');
            videoElement.setAttribute('playsinline', '');
            videoElement.setAttribute('muted', '');
            videoElement.setAttribute('webkit-playsinline', '');
            
            // æ·»åŠ è§†é¢‘åŠ è½½äº‹ä»¶ç›‘å¬
            videoElement.addEventListener('loadedmetadata', () => {
                console.log('è§†é¢‘å…ƒæ•°æ®åŠ è½½å®Œæˆï¼Œå°ºå¯¸:', videoElement.videoWidth, 'x', videoElement.videoHeight);
            });
            
            videoElement.addEventListener('playing', () => {
                console.log('è§†é¢‘å¼€å§‹æ’­æ”¾ï¼');
                const statusText = document.getElementById('gesture-status');
                statusText.innerText = "æ‘„åƒå¤´å·²å¯åŠ¨ï¼Œè¯·å°†æ‰‹æ”¾åœ¨æ‘„åƒå¤´å‰";
                statusText.style.color = '#00ffff';
            });
            
            videoElement.addEventListener('error', (e) => {
                console.error('è§†é¢‘å…ƒç´ é”™è¯¯:', e);
            });
            
            const camera = new Camera(videoElement, {
                onFrame: async () => {
                    await hands.send({image: videoElement});
                },
                width: 640,
                height: 480
            });
            
            console.log('å¯åŠ¨æ‘„åƒå¤´...');
            camera.start().then(() => {
                console.log('Camera.start() è°ƒç”¨æˆåŠŸ');
                
                // ç­‰å¾…ä¸€ä¸‹ï¼Œæ£€æŸ¥è§†é¢‘æ˜¯å¦çœŸçš„åœ¨æ’­æ”¾
                setTimeout(() => {
                    if (videoElement.readyState >= 2 && videoElement.videoWidth > 0) { // HAVE_CURRENT_DATA
                        console.log('æ‘„åƒå¤´å¯åŠ¨æˆåŠŸï¼è§†é¢‘çŠ¶æ€:', {
                            readyState: videoElement.readyState,
                            paused: videoElement.paused,
                            width: videoElement.videoWidth,
                            height: videoElement.videoHeight,
                            srcObject: !!videoElement.srcObject
                        });
                        const statusText = document.getElementById('gesture-status');
                        statusText.innerText = "æ‘„åƒå¤´å·²å¯åŠ¨ï¼Œè¯·å°†æ‰‹æ”¾åœ¨æ‘„åƒå¤´å‰";
                        statusText.style.color = '#00ffff';
                    } else {
                        console.warn('æ‘„åƒå¤´å¯èƒ½æœªæ­£å¸¸å¯åŠ¨ï¼Œå°è¯•å¤‡ç”¨æ–¹æ³•...');
                        console.log('è§†é¢‘çŠ¶æ€:', {
                            readyState: videoElement.readyState,
                            paused: videoElement.paused,
                            width: videoElement.videoWidth,
                            height: videoElement.videoHeight,
                            srcObject: !!videoElement.srcObject
                        });
                        
                        // å°è¯•å¤‡ç”¨æ–¹æ³•
                        initCameraDirectly().then(success => {
                            if (success) {
                                const statusText = document.getElementById('gesture-status');
                                statusText.innerText = "æ‘„åƒå¤´å·²å¯åŠ¨ï¼ˆå¤‡ç”¨æ–¹æ³•ï¼‰ï¼Œè¯·å°†æ‰‹æ”¾åœ¨æ‘„åƒå¤´å‰";
                                statusText.style.color = '#00ffff';
                            } else {
                                const statusText = document.getElementById('gesture-status');
                                statusText.innerText = "æ‘„åƒå¤´å¯åŠ¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥æƒé™";
                                statusText.style.color = '#ff4444';
                            }
                        });
                    }
                }, 1000);
                
                // 3ç§’åæ¢å¤é»˜è®¤é¢œè‰²
                setTimeout(() => {
                    const statusText = document.getElementById('gesture-status');
                    if (statusText.style.color === 'rgb(0, 255, 255)') {
                        statusText.style.color = '';
                    }
                }, 3000);
            }).catch(err => {
                console.error("æ‘„åƒå¤´å¯åŠ¨å¤±è´¥:", err);
                console.log('å°è¯•ä½¿ç”¨å¤‡ç”¨æ–¹æ³•åˆå§‹åŒ–æ‘„åƒå¤´...');
                
                // å°è¯•å¤‡ç”¨æ–¹æ³•
                initCameraDirectly().then(success => {
                    if (success) {
                        const statusText = document.getElementById('gesture-status');
                        statusText.innerText = "æ‘„åƒå¤´å·²å¯åŠ¨ï¼ˆå¤‡ç”¨æ–¹æ³•ï¼‰ï¼Œè¯·å°†æ‰‹æ”¾åœ¨æ‘„åƒå¤´å‰";
                        statusText.style.color = '#00ffff';
                    } else {
                        const statusText = document.getElementById('gesture-status');
                        statusText.innerText = "æ‘„åƒå¤´å¯åŠ¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥æƒé™";
                        statusText.style.color = '#ff4444';
                        alert("æ— æ³•å¯åŠ¨æ‘„åƒå¤´ï¼Œè¯·ç¡®ä¿åœ¨ HTTPS æˆ– Localhost ç¯å¢ƒä¸‹è¿è¡Œï¼Œå¹¶å…è®¸æ‘„åƒå¤´æƒé™ã€‚\né”™è¯¯ä¿¡æ¯: " + err.message);
                    }
                });
            });
        }

        // ç­‰å¾…MediaPipeåº“åŠ è½½å®Œæˆ
        function checkAndInit() {
            if (typeof Hands !== 'undefined' && typeof Camera !== 'undefined') {
                initMediaPipe();
            } else {
                console.log('ç­‰å¾… MediaPipe åº“åŠ è½½...');
                setTimeout(checkAndInit, 200);
            }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                setTimeout(checkAndInit, 500);
            });
        } else {
            setTimeout(checkAndInit, 500);
        }
        
        // æ·»åŠ è°ƒè¯•æ¨¡å¼å¼€å…³ï¼ˆåœ¨æ§åˆ¶å°è¾“å…¥ window.debugMode = true å¯å¼€å¯ï¼‰
        window.debugMode = false;
        
        // åˆ‡æ¢è°ƒè¯•è§†å›¾
        function toggleDebug() {
            const video = document.getElementById('input_video');
            const toggle = document.getElementById('debugToggle');
            if (video.classList.contains('debug')) {
                video.classList.remove('debug');
                toggle.innerText = 'ğŸ” æ˜¾ç¤ºæ‘„åƒå¤´';
            } else {
                video.classList.add('debug');
                toggle.innerText = 'âŒ éšè—æ‘„åƒå¤´';
                // ç¡®ä¿è§†é¢‘åœ¨è°ƒè¯•æ¨¡å¼ä¸‹å¯è§
                if (video.readyState >= 2) {
                    console.log('è°ƒè¯•æ¨¡å¼ï¼šè§†é¢‘å°ºå¯¸', video.videoWidth, 'x', video.videoHeight);
                } else {
                    console.warn('è°ƒè¯•æ¨¡å¼ï¼šè§†é¢‘å°šæœªåŠ è½½');
                }
            }
        }
        
        // å…¨å±€æš´éœ²è°ƒè¯•å‡½æ•°
        window.toggleDebug = toggleDebug;

    </script>
</body>
</html>